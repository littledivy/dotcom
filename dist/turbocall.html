<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta charset="utf-8"><title>Just-in-time compiler for Deno FFI</title><meta name="og:title" content="Just-in-time compiler for Deno FFI"><meta name="og:site_name" content="littledivy.com"><meta name="description" content="Divy’s personal website."><meta name="og:description" content="Divy’s personal website."><meta name="twitter:description" content="Divy’s personal website."><meta name="author" content="Divy Srivastava"><meta name="og:type" content="website"><meta name="og:image" content="/static/logo/button.png"><meta name="twitter:site" content="@undefined_void"><meta name="twitter:creator" content="@undefined_void"><meta name="twitter:title" content="Just-in-time compiler for Deno FFI"><meta name="twitter:image" content="/static/logo/button.png"><meta name="robots" content="index, follow"><link rel="preload" as="font" href="/fonts/valkyrie_ot_a_regular.woff2" crossorigin><link rel="preload" as="font" href="/fonts/valkyrie_ot_a_italic.woff2" crossorigin><style>
@font-face {
  font-family: "Moranga";
  font-style: normal;
  font-display: swap;
  font-weight: 300;
  src: url("/fonts/Moranga-Regular.woff2") format("woff2");
}

@font-face {
  font-family: "Source Sans 3";
  font-style: normal;
  font-display: swap;
  font-weight: 300;
  src: url("/fonts/source-sans-3-latin-300-normal.woff2") format("woff2");

}

@font-face {
  font-family: "Source Sans 3";
  font-style: normal;
  font-display: swap;
  font-weight: 400;
  src: url("/fonts/source-sans-3-latin-400-normal.woff2") format("woff2");
}

@font-face {
  font-family: "Valkyrie A";
  font-style: normal;
  font-weight: normal;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/valkyrie_ot_a_regular.woff2") format("woff2");
}

@font-face {
  font-family: "Valkyrie A";
  font-style: italic;
  font-weight: normal;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/valkyrie_ot_a_italic.woff2") format("woff2");
}

@font-face {
  font-family: "Valkyrie A";
  font-style: normal;
  font-weight: bold;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/valkyrie_ot_a_bold.woff2") format("woff2");
}

@font-face {
  font-family: "Valkyrie A";
  font-style: italic;
  font-weight: bold;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/valkyrie_ot_a_bold_italic.woff2") format("woff2");
}

@font-face {
  font-family: "Concourse Index";
  font-style: normal;
  font-weight: normal;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/concourse_index_regular.woff2") format("woff2");
}
    </style><link rel="stylesheet" href="/bundle.css">
<link
    rel="preload"
    href="/styles/prism-catppuccin.css"
    as="style"
    media="screen"
    onload="this.onload=null;this.rel='stylesheet'"
>
<link
    rel="preload"
    href="/styles/prism-rose-pine.css"
    as="style"
    media="screen and (prefers-color-scheme: dark)"
    onload="this.onload=null;this.rel='stylesheet'"
>
<script async src="/icons.js"></script><script async src="/index.js"></script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-core.min.js" id="prism-script"></script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/plugins/autoloader/prism-autoloader.min.js" id="prism-autoloader"></script><noscript><link rel="stylesheet" media="screen" href="/styles/prism-catppuccin.css"><link rel="stylesheet" media="screen and (prefers-color-scheme: dark)" href="/styles/prism-rose-pine.css"></noscript></head><body class="antialiased mt-4 lg:mt-20 leading-relaxed mx-auto max-w-[1200px]"><div class="flex gap-8 px-4 lg:px-6"><aside class="hidden md:block w-64 flex-none"><a href="/" class="inline-flex justify-between gap-4 hover:bg-subtle/50 transition-colors mt-3"><span class="text-[2.5em] select-none -translate-y-[6px]">divy</span></a><nav class="space-y-4 mt-4"><ul class="space-y-2 text-love text-2xl "></ul><div class="space-y-1"><p class="all-smallcaps text-lg">Writeups</p><ul class="space-y-2 text-subtle text-base"><li><a class="hover:bg-surface transition-colors" href="/resym">Remote stack trace symolication</a></li><li><a class="hover:bg-surface transition-colors" href="/sh-deno">Security hardened Deno for macOS</a></li><li><a class="hover:bg-surface transition-colors" href="/turbocall">Turbocall JIT</a></li><li><a class="hover:bg-surface transition-colors" href="/sui">Inject RO data into executables</a></li></ul></div><div class="space-y-1"><p class="all-smallcaps text-lg">Talks</p><ul class="space-y-2 text-subtle text-base"><ul class="space-y-4"><li><a href="https://youtu.be/qt3-3FkPqQ8?t=450" class="block hover:underline transition-all duration-300 ease-out font-medium">Kernel to runtime: inside a JavaScript runtime</a><span class="block text-sm text-gray-400 mt-1">IIT Kanpur (Sept 2025)</span></li><li><a href="https://www.youtube.com/watch?v=vINOqgn_ik8" class="block hover:underline transition-all duration-300 ease-out font-medium">Deno under the hood: op2</a><span class="block text-sm text-gray-400 mt-1">Dublin (Dec 2024)</span></li><li><a href="https://www.youtube.com/watch?v=RKjVcl62J9w" class="block hover:underline transition-all duration-300 ease-out font-medium">Building games with Deno</a><span class="block text-sm text-gray-400 mt-1">Warsaw (Aug 2024)</span></li><li><a href="https://www.youtube.com/watch?v=gA152Hun8cI" class="block hover:underline transition-all duration-300 ease-out font-medium">WebGPU windowing</a><span class="block text-sm text-gray-400 mt-1">Warsaw (Aug 2024)</span></li><li><a href="https://www.youtube.com/watch?v=5wlZDw942J8" class="block hover:underline transition-all duration-300 ease-out font-medium">How deno compile works</a><span class="block text-sm text-gray-400 mt-1">India (Sep 2024)</span></li><li><a href="https://www.youtube.com/watch?v=ssYN4rFWRIU" class="block hover:underline transition-all duration-300 ease-out font-medium">Blazing fast FFI</a><span class="block text-sm text-gray-400 mt-1">Tokyo (Nov 2023)</span></li></ul></ul></div></nav></aside><div class="flex-1 md:mt-2"><header class="md:hidden border-b border-dashed border-muted mb-8 pb-8 w-full"><div class="w-full flex justify-center"><a href="/" class="inline-flex justify-between gap-4 hover:bg-subtle/50 transition-colors mt-8 mx-auto"><span class="italic text-[3em] text-center select-none -translate-y-2 mx-auto">divy</span></a></div><details class="w-full mt-4"><summary class="text-center smallcaps text-xl cursor-pointer">menu</summary><nav class="space-y-4 text-2xl mt-3"><ul class="space-y-3 text-2xl text-love"></ul><div class="space-y-2"><span class="all-smallcaps text-lg">Writeups</span><ul class="space-y-2 text-subtle text-lg"><li><a class="hover:bg-surface transition-colors" href="/resym">Remote stack trace symolication</a></li><li><a class="hover:bg-surface transition-colors" href="/sh-deno">Security hardened Deno for macOS</a></li><li><a class="hover:bg-surface transition-colors" href="/turbocall">Turbocall JIT</a></li><li><a class="hover:bg-surface transition-colors" href="/sui">Inject RO data into executables</a></li></ul></div><div class="space-y-2"><span class="all-smallcaps text-lg">Talks</span><ul class="space-y-2 text-subtle text-lg"><ul class="space-y-4"><li><a href="https://youtu.be/qt3-3FkPqQ8?t=450" class="block hover:underline transition-all duration-300 ease-out font-medium">Kernel to runtime: inside a JavaScript runtime</a><span class="block text-sm text-gray-400 mt-1">IIT Kanpur (Sept 2025)</span></li><li><a href="https://www.youtube.com/watch?v=vINOqgn_ik8" class="block hover:underline transition-all duration-300 ease-out font-medium">Deno under the hood: op2</a><span class="block text-sm text-gray-400 mt-1">Dublin (Dec 2024)</span></li><li><a href="https://www.youtube.com/watch?v=RKjVcl62J9w" class="block hover:underline transition-all duration-300 ease-out font-medium">Building games with Deno</a><span class="block text-sm text-gray-400 mt-1">Warsaw (Aug 2024)</span></li><li><a href="https://www.youtube.com/watch?v=gA152Hun8cI" class="block hover:underline transition-all duration-300 ease-out font-medium">WebGPU windowing</a><span class="block text-sm text-gray-400 mt-1">Warsaw (Aug 2024)</span></li><li><a href="https://www.youtube.com/watch?v=5wlZDw942J8" class="block hover:underline transition-all duration-300 ease-out font-medium">How deno compile works</a><span class="block text-sm text-gray-400 mt-1">India (Sep 2024)</span></li><li><a href="https://www.youtube.com/watch?v=ssYN4rFWRIU" class="block hover:underline transition-all duration-300 ease-out font-medium">Blazing fast FFI</a><span class="block text-sm text-gray-400 mt-1">Tokyo (Nov 2023)</span></li></ul></ul></div></nav></details></header><main class="main-content lg:max-w-[40rem]"><h1 class="all-smallcaps md:text-3xl text-2xl text-center mt-4">Just-in-time compiler for Deno FFI</h1><div class="space-y-1 text-center mt-4"><p class="text-subtle text-md md:text-lg">25 March 2024</p></div><div id="typst-injected" class="prose-lg lg:prose-xl mt-8 prose-headings:all-smallcaps prose-headings:text-love prose-h1:text-foreground prose-list-snazzy prose-table-snazzy">    <p>V8 Isolates are little sandboxes that run JS. JavaScript runtimes give you the ability to call native functions by reaching out of this sandbox. These native functions are often referred to as "bindings".</p>
    <p>Optimizing these bindings are one of the most important optimizations in a JavaScript runtime. Over the years, V8 has made significant improvements in this area to make bindings faster for embedders.</p>
    <p>Let's look at an example of a V8 C++ binding:</p>
    <pre><code class="language-cpp">void Add(const FunctionCallbackInfo&lt;Value>&amp; args) {
  Isolate* isolate = args.GetIsolate();
  // Check the number of arguments passed.
  if (args.Length() &lt; 2) {
    isolate->ThrowException(Exception::TypeError(
        String::NewFromUtf8(isolate, "Wrong number of arguments", NewStringType::kNormal).ToLocalChecked()));
    return;
  }
  // Check the argument types
  if (!args[0]->IsNumber() || !args[1]->IsNumber()) {
    isolate->ThrowException(Exception::TypeError(
        String::NewFromUtf8(isolate, "Wrong arguments", NewStringType::kNormal).ToLocalChecked()));
    return;
  }
  // Convert the arguments to numbers.
  double value = args[0]->NumberValue(isolate) + args[1]->NumberValue(isolate);
  // Create a new Number value and set it as the return value.
  Local&lt;Number> num = Number::New(isolate, value);
  args.GetReturnValue().Set(num);
}</code></pre>
    <p>This does a bunch of stuff, like checking the number of arguments, type checking, converting arguments and setting the return value. Moreover, V8 has to jump through (quite literally) a lot of hoops to make this work. It sets up guards and jumps out of the optimized JIT code to the runtime.</p>
    <p>What if there was a way to call bindings without moving out of the optimized JIT code and without all the type checks?</p>
    <h2 class="!text-foreground">V8 Fast API Calls</h2>
    <p>V8 Fast calls are a relatively new optimization in V8.</p>
    <p>V8 can call our native binding directly from the optimized JIT code if we provide it with the necessary type information. The necessary typechecks happen in the compiler itself including fallback to the slow path.</p>
    <pre><code class="language-cpp">int FastAdd(int a, int b);

// Extracts type information from the function signature
v8::CFunction fast_add = MakeV8CFunction(FastAdd);</code></pre>
    <p>This results in massive speedups for repetitve native calls from optimized JavaScript. The calls are inlined and theoretically as fast as calling a native function.</p>
    <p>Apart from native runtime bindings, one of the most common places where this optimization is used is in FFI (Foreign Function Interface) calls.</p>
    <h2 class="!text-foreground">Enter Deno FFI</h2>
    <pre><code class="language-typescript">const { symbols } = Deno.dlopen("libc.6.so", {
  open: {
    parameters: ["buffer", "i32"],
    result: "i32",
  },
});</code></pre>
    <p>Deno.dlopen is the API to open a dynamic library. Notice anything familiar? We are defining the number of arguments, types and the return value.</p>
    <p>We could use this information to generate optimized native binding and give it to V8!</p>
    <h2 class="!text-foreground">Turbocall: a JIT for JIT^1</h2>
    <p>Deno created a tiny assembler (in Rust ofc) to generate optimized bindings for FFI calls based on the type information.</p>
    <pre><code class="language-typescript">Deno.dlopen("libtest.so", {
  func: {
    parameters: ["buffer", "i32", "i32"],
    result: "i32",
  },
});</code></pre>
    <p>Turbocall generates the following bindings:</p>
    <pre><code class="language-asm">.arch aarch64

ldr x0, [x1, #8] ; buffer->data
mov x1, x2       ; a
mov x2, x3       ; b

moxz x8, 0
br x8            ; tailcall</code></pre>
    <p>This is simply ARM64 assembly for something like this in C:</p>
    <pre><code class="language-c">int func_trampoline(
  void* _this,
  FastApiTypedArray* buffer,
  int a,
  int b
) {
  return func(buffer->data, a, b);
}</code></pre>
    <p>Most notably, it generates code to properly pass JS typed arrays and arguments to the native FFI symbol.</p>
    <p>I gave a talk on this topic at the DenoFest Meetup in Tokyo^2 which goes into more detail about the implementation.</p>
    <h2 class="!text-foreground">Benchmarks</h2>
    <p>This made FFI calls 100x faster in Deno: <a href="https://github.com/denoland/deno/pull/15125">https://github.com/denoland/deno/pull/15125</a></p>
    <p>Let's see how this compares against other runtimes.</p>
    <p>Benchmark comparing Deno, Bun and Node.js on Sqlite and DuckDB</p>
    <img src="/static/img/deno.png" alt="Deno FFI Benchmarks" class="rounded-md mx-auto shadow-sm dark:shadow-none shadow-gray-900 my-4 rounded-lg shadow-lg" loading="lazy">
    <p>This is running sqlite3 and duckdb benchmarks on Deno, Bun and Node.js. See benchmark source.^3</p>
    <h2 class="!text-foreground">Turbocall in action</h2>
    <p>Slide from the DenoFest talk:</p>
    <img src="/static/img/turbocall-slide.png" alt="Turbocall in action" class="rounded-md mx-auto shadow-sm dark:shadow-none shadow-gray-900 my-4 rounded-lg shadow-lg" loading="lazy">
    <h2 class="!text-foreground">Future</h2>
    <p>It will be interesting to see how Static Hermes^4 will compare against V8 fast calls. Both can probably generate similar code at runtime but implemented very differently.</p>
    <p>I'm also excited about just-js/lo^5 which is a WIP low-level JS runtime that aims to generate V8 fast calls bindings ahead-of-time (similar to Deno) but also allow for a more engine-agnostic design where you could swap out V8 for other engines like Hermes, Quickjs.</p>
    <p>That's it! Feel free to follow me on Twitter: <a href="https://twitter.com/undefined_void">https://twitter.com/undefined_void</a></p>
    <p>This document is available as PDF: <a href="https://littledivy.com/turbocall.pdf">https://littledivy.com/turbocall.pdf</a></p></div><footer class="mt-8 mb-4 text-sm text-muted py-1"><p class="all-smallcaps leading-[1.3]"> <a class="text-link" href="https://github.com/littledivy/web/commit/unstable">unstable</a> build using rustc 1.91.0-nightly at 1969-12-31 17:00:00 utc-07. </p></footer></main></div></div></body></html>