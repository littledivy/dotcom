<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta charset="utf-8"><title>Inject RO data into existing executables</title><meta name="og:title" content="Inject RO data into existing executables"><meta name="og:site_name" content="Divy’s Website"><meta name="description" content="Divy’s personal website."><meta name="og:description" content="Divy’s personal website."><meta name="twitter:description" content="Divy’s personal website."><meta name="author" content="Divy Srivastava"><meta name="og:type" content="website"><meta name="og:image" content="/static/logo/button.png"><meta name="twitter:site" content="@undefined_void"><meta name="twitter:creator" content="@undefined_void"><meta name="twitter:title" content="Inject RO data into existing executables"><meta name="twitter:image" content="/static/logo/button.png"><meta name="robots" content="index, follow"><link rel="preload" as="font" href="/fonts/valkyrie_ot_a_regular.woff2" crossorigin><link rel="preload" as="font" href="/fonts/valkyrie_ot_a_italic.woff2" crossorigin><style>
@font-face {
  font-family: "Moranga";
  font-style: normal;
  font-display: swap;
  font-weight: 300;
  src: url("/fonts/Moranga-Regular.woff2") format("woff2");
}

@font-face {
  font-family: "Source Sans 3";
  font-style: normal;
  font-display: swap;
  font-weight: 300;
  src: url("/fonts/source-sans-3-latin-300-normal.woff2") format("woff2");

}

@font-face {
  font-family: "Source Sans 3";
  font-style: normal;
  font-display: swap;
  font-weight: 400;
  src: url("/fonts/source-sans-3-latin-400-normal.woff2") format("woff2");
}

@font-face {
  font-family: "Valkyrie A";
  font-style: normal;
  font-weight: normal;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/valkyrie_ot_a_regular.woff2") format("woff2");
}

@font-face {
  font-family: "Valkyrie A";
  font-style: italic;
  font-weight: normal;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/valkyrie_ot_a_italic.woff2") format("woff2");
}

@font-face {
  font-family: "Valkyrie A";
  font-style: normal;
  font-weight: bold;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/valkyrie_ot_a_bold.woff2") format("woff2");
}

@font-face {
  font-family: "Valkyrie A";
  font-style: italic;
  font-weight: bold;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/valkyrie_ot_a_bold_italic.woff2") format("woff2");
}

@font-face {
  font-family: "Concourse Index";
  font-style: normal;
  font-weight: normal;
  font-stretch: normal;
  font-display: swap;
  src: url("/fonts/concourse_index_regular.woff2") format("woff2");
}
    </style><link rel="stylesheet" href="/bundle.css">
<link
    rel="preload"
    href="/styles/prism-catppuccin.css"
    as="style"
    media="screen"
    onload="this.onload=null;this.rel='stylesheet'"
>
<link
    rel="preload"
    href="/styles/prism-rose-pine.css"
    as="style"
    media="screen and (prefers-color-scheme: dark)"
    onload="this.onload=null;this.rel='stylesheet'"
>
<script async src="/icons.js"></script><script async src="/index.js"></script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-core.min.js" id="prism-script"></script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/plugins/autoloader/prism-autoloader.min.js" id="prism-autoloader"></script><noscript><link rel="stylesheet" media="screen" href="/styles/prism-catppuccin.css"><link rel="stylesheet" media="screen and (prefers-color-scheme: dark)" href="/styles/prism-rose-pine.css"></noscript></head><body class="antialiased mt-4 lg:mt-20 leading-relaxed mx-auto max-w-[1200px]"><div class="flex gap-8 px-4 lg:px-6"><aside class="hidden md:block w-64 flex-none"><a href="/" class="inline-flex justify-between gap-4 hover:bg-subtle/50 transition-colors mt-3"><span class="text-[2.5em] select-none -translate-y-[6px]">divy</span></a><nav class="space-y-4 mt-4"><ul class="space-y-2 text-love text-2xl "></ul><div class="space-y-1"><p class="all-smallcaps text-lg">Writeups</p><ul class="space-y-2 text-subtle text-base"><li><a class="hover:bg-surface transition-colors" href="/resym">Remote stack trace symolication</a></li><li><a class="hover:bg-surface transition-colors" href="/sh-deno">Security hardened Deno for macOS</a></li><li><a class="hover:bg-surface transition-colors" href="/turbocall">Turbocall JIT</a></li><li><a class="hover:bg-surface transition-colors" href="/sui">Inject RO data into executables</a></li></ul></div><div class="space-y-1"><p class="all-smallcaps text-lg">Talks</p><ul class="space-y-2 text-subtle text-base"><ul class="space-y-4"><li><a href="https://youtu.be/qt3-3FkPqQ8?t=450" class="block hover:underline transition-all duration-300 ease-out font-medium">Kernel to runtime: inside a JavaScript runtime</a><span class="block text-sm text-gray-400 mt-1">IIT Kanpur (Sept 2025)</span></li><li><a href="https://www.youtube.com/watch?v=vINOqgn_ik8" class="block hover:underline transition-all duration-300 ease-out font-medium">Deno under the hood: op2</a><span class="block text-sm text-gray-400 mt-1">Dublin (Dec 2024)</span></li><li><a href="https://www.youtube.com/watch?v=RKjVcl62J9w" class="block hover:underline transition-all duration-300 ease-out font-medium">Building games with Deno</a><span class="block text-sm text-gray-400 mt-1">Warsaw (Aug 2024)</span></li><li><a href="https://www.youtube.com/watch?v=gA152Hun8cI" class="block hover:underline transition-all duration-300 ease-out font-medium">WebGPU windowing</a><span class="block text-sm text-gray-400 mt-1">Warsaw (Aug 2024)</span></li><li><a href="https://www.youtube.com/watch?v=5wlZDw942J8" class="block hover:underline transition-all duration-300 ease-out font-medium">How deno compile works</a><span class="block text-sm text-gray-400 mt-1">India (Sep 2024)</span></li><li><a href="https://www.youtube.com/watch?v=ssYN4rFWRIU" class="block hover:underline transition-all duration-300 ease-out font-medium">Blazing fast FFI</a><span class="block text-sm text-gray-400 mt-1">Tokyo (Nov 2023)</span></li></ul></ul></div></nav></aside><div class="flex-1 md:mt-2"><header class="md:hidden border-b border-dashed border-muted mb-8 pb-8 w-full"><div class="w-full flex justify-center"><a href="/" class="inline-flex justify-between gap-4 hover:bg-subtle/50 transition-colors mt-8 mx-auto"><span class="italic text-[3em] text-center select-none -translate-y-2 mx-auto">divy</span></a></div><details class="w-full mt-4"><summary class="text-center smallcaps text-xl cursor-pointer">menu</summary><nav class="space-y-4 text-2xl mt-3"><ul class="space-y-3 text-2xl text-love"></ul><div class="space-y-2"><span class="all-smallcaps text-lg">Writeups</span><ul class="space-y-2 text-subtle text-lg"><li><a class="hover:bg-surface transition-colors" href="/resym">Remote stack trace symolication</a></li><li><a class="hover:bg-surface transition-colors" href="/sh-deno">Security hardened Deno for macOS</a></li><li><a class="hover:bg-surface transition-colors" href="/turbocall">Turbocall JIT</a></li><li><a class="hover:bg-surface transition-colors" href="/sui">Inject RO data into executables</a></li></ul></div><div class="space-y-2"><span class="all-smallcaps text-lg">Talks</span><ul class="space-y-2 text-subtle text-lg"><ul class="space-y-4"><li><a href="https://youtu.be/qt3-3FkPqQ8?t=450" class="block hover:underline transition-all duration-300 ease-out font-medium">Kernel to runtime: inside a JavaScript runtime</a><span class="block text-sm text-gray-400 mt-1">IIT Kanpur (Sept 2025)</span></li><li><a href="https://www.youtube.com/watch?v=vINOqgn_ik8" class="block hover:underline transition-all duration-300 ease-out font-medium">Deno under the hood: op2</a><span class="block text-sm text-gray-400 mt-1">Dublin (Dec 2024)</span></li><li><a href="https://www.youtube.com/watch?v=RKjVcl62J9w" class="block hover:underline transition-all duration-300 ease-out font-medium">Building games with Deno</a><span class="block text-sm text-gray-400 mt-1">Warsaw (Aug 2024)</span></li><li><a href="https://www.youtube.com/watch?v=gA152Hun8cI" class="block hover:underline transition-all duration-300 ease-out font-medium">WebGPU windowing</a><span class="block text-sm text-gray-400 mt-1">Warsaw (Aug 2024)</span></li><li><a href="https://www.youtube.com/watch?v=5wlZDw942J8" class="block hover:underline transition-all duration-300 ease-out font-medium">How deno compile works</a><span class="block text-sm text-gray-400 mt-1">India (Sep 2024)</span></li><li><a href="https://www.youtube.com/watch?v=ssYN4rFWRIU" class="block hover:underline transition-all duration-300 ease-out font-medium">Blazing fast FFI</a><span class="block text-sm text-gray-400 mt-1">Tokyo (Nov 2023)</span></li></ul></ul></div></nav></details></header><main class="main-content lg:max-w-[40rem]"><h1 class="all-smallcaps md:text-3xl text-2xl text-center mt-4">Inject RO data into existing executables</h1><div class="space-y-1 text-center mt-4"><p class="text-subtle text-md md:text-lg">17 August 2024</p></div><div id="typst-injected" class="prose-lg lg:prose-xl mt-8 prose-headings:all-smallcaps prose-headings:text-love prose-h1:text-foreground prose-list-snazzy prose-table-snazzy">    <h2>Description</h2>
    <p>This document describes inner workings of sui, an injection tool for embedding arbitrary data into precompiled executables (ELF, PE and Mach-O).</p>
    <p>It is cross-platform and supports cross-"patching" for all formats. Under the hood sui uses format-specific features described in Supported formats.</p>
    <p>It produces valid executables that can be code-signed and distributed.</p>
    <p>Emebedded data can be accessed by the executable at runtime using libsui library. Using sui</p>
    <p>It is available as a Rust crate and a command-line tool.</p>
    <pre>cargo add libsui</pre>
    <h2>Run-time</h2>
    <p>Find and extract the embedded data from the executable:</p>
    <pre><code class="language-rust">use libsui::find_section;
 
if let Some(data) = find_section("mydata") {
	// found
}</code></pre>
    <p>Name of the section is the same as the one used during injection. It refers to the section name in Mach-O, resource name in PE and tag in ELF.</p>
    <h2>Injecting</h2>
    <p>Build and sign a new Mach-O executable:</p>
    <pre><code class="language-rust">use sui::Macho;
 
Macho::from(input)? // load an existing executable
	.write_section("mydata", data)? // write a new section with auxiliary data
	.build_and_sign(output)?; // build and sign the executable</code></pre>
    <p>Build a new Portable Executable:</p>
    <pre><code class="language-rust">use sui::PortableExecutable;
 
PortableExecutable::from(input)? // load an existing executable
	.write_resource("mydata", data)? // inject a new resource (RCDATA) with auxiliary data
	.build(output)?; // build and sign the executable
</code></pre>
    <p>Build a new ELF executable:</p>
    <pre><code class="language-rust">use sui::Elf;
 
Elf::from(input)? // load an existing executable
	.append("mydata", data)? // tag and append auxiliary data
	.build(output)?; // build</code></pre>
    <p>Build a new PE with icon:</p>
    <pre><code class="language-rust">use sui::PortableExecutable;
 
PortableExecutable::from(input)? // load an existing executable
	.write_resource("mydata", data)? // inject a new resource (RCDATA) with auxiliary data
	.write_icon("icon.ico")? // inject an icon resource (RT_ICON)
	.build(output)?; // build
</code></pre>
    <p>Ad-hoc codesign a modified arm64 Mach-O executable:</p>
    <pre><code class="language-rust">use sui::apple_codesign::MachoSigner;
 
MachoSigner::new(input)? // load an existing executable
	.sign(output)?; // sign the executable with ad-hoc signature
</code></pre>
    <p>Refer to the API documentation for more up-to-date documentation.</p>
    <h2>Supported formats</h2>
    <p>ELF, PE and Mach-O are supported.</p>
    <h3>Mach-O</h3>
    <p>Resource is added as section in a new segment, load commands are updated and offsets are adjusted. __LINKEDIT is kept at the end of the file.</p>
    <p>It is similar to linker's -sectcreate,__FOO,__foo,hello.txt option.</p>
    <p>Note that Macho::build will invalidate existing code signature. on Apple sillicon, kernel refuses to run executables with bad signatures.</p>
    <p>Use Macho::build_and_sign to re-sign the binary with ad-hoc signature. See apple_codesign.rs for details. This is similar to <code>codesign -s - ./out</code> command.</p>
    <pre><code class="language-rust">Macho::from(exe)?
    .write_section("__sect", data)?
    .build_and_sign(&amp;mut out)?;
</code></pre>
    <pre>$ codesign -d -vvv ./out<br><br>Executable=/Users/divy/gh/sui/out<br>Identifier=a.out<br>Format=Mach-O thin (arm64)<br>CodeDirectory v=20400 size=10238 flags=0x20002(adhoc,linker-signed) hashes=317+0 location=embedded<br>Hash type=sha256 size=32<br>CandidateCDHash sha256=6b1abb20f2291dd9b0dbcd0659a918cb2d0e6b18<br>CandidateCDHashFull sha256=6b1abb20f2291dd9b0dbcd0659a918cb2d0e6b1876153efa17f90dc8b3a8f177<br>Hash choices=sha256<br>CMSDigest=6b1abb20f2291dd9b0dbcd0659a918cb2d0e6b1876153efa17f90dc8b3a8f177<br>CMSDigestType=2<br>CDHash=6b1abb20f2291dd9b0dbcd0659a918cb2d0e6b18<br>Signature=adhoc<br>Info.plist=not bound<br>TeamIdentifier=not set<br>Sealed Resources=none<br>Internal requirements=none</pre>
    <h3>ELF</h3>
    <p>Data is simply appended to the end of the file with a tag and magic descriptor. Extracted from current_exe() at run-time.</p>
    <p>This is subject to change and may use ELF linker notes (PT_NOTE) in the future.</p>
    <h3>PE</h3>
    <p>Resource is added into a new PE resource directory as RT_RCDATA type and extracted using FindResource and LoadResource at run-time.</p>
    <h2>Comparison with postject</h2>
    <p>Sui supports ad-hoc codesigning for Mach-O executables and Icon resources for PE executables which postject does not.</p>
    <p>Sui is much faster and lightweight compared to postject which is built on top of LIEF, a heavy C++ dependency.</p>
    <pre>$ time sui ./node test.txt ./out<br>0m0.151s<br><br>$ time postject ./node name test.txt<br>0m8.993s</pre>
    <h2>Conclusion</h2>
    <p>sui is open-source on Github: <a href="https://github.com/denoland/sui">https://github.com/denoland/sui</a> and is the tech behind deno compile, converts JavaScript and TypeScript code into a single executable.</p></div><footer class="mt-8 mb-4 text-sm text-muted py-1"><p class="all-smallcaps leading-[1.3]"> <a class="text-link" href="https://github.com/littledivy/web/commit/unstable">unstable</a> build using rustc 1.91.0-nightly at 1969-12-31 17:00:00 utc-07. </p></footer></main></div></div></body></html>